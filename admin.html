<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>å‹¤æ€ ç®¡ç† - ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    background: #F5F5F5;
    color: #212121;
    min-height: 100vh;
    -webkit-text-size-adjust: 100%;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .header {
    background: linear-gradient(135deg, #1565C0, #1976D2);
    color: white;
    padding: 20px 16px;
    padding-top: max(env(safe-area-inset-top, 20px), 20px);
    text-align: center;
  }
  .header h1 { font-size: 20px; font-weight: 700; }
  .header p { font-size: 13px; opacity: 0.85; margin-top: 4px; }

  /* ã‚³ãƒ³ãƒ†ãƒŠ */
  .container {
    padding: 20px 16px;
    max-width: 480px;
    margin: 0 auto;
  }

  /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .section {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  .section-title {
    font-size: 15px;
    font-weight: 700;
    color: #424242;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title .icon {
    font-size: 20px;
  }

  /* URLè¨­å®š */
  .url-input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .url-input {
    width: 100%;
    padding: 12px 14px;
    border: 2px solid #E0E0E0;
    border-radius: 12px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
    font-family: inherit;
  }
  .url-input:focus {
    border-color: #1976D2;
  }
  .url-status {
    font-size: 12px;
    color: #757575;
    padding: 0 4px;
  }
  .url-status.saved { color: #2E7D32; }

  /* ãƒœã‚¿ãƒ³å…±é€š */
  .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    padding: 16px;
    border: none;
    border-radius: 14px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.1s, opacity 0.2s;
    -webkit-tap-highlight-color: transparent;
    font-family: inherit;
  }
  .btn:active {
    transform: scale(0.97);
  }
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  .btn .btn-icon {
    font-size: 22px;
  }

  /* ãƒã‚§ãƒƒã‚¯æ›´æ–°ãƒœã‚¿ãƒ³ */
  .btn-refresh {
    background: linear-gradient(135deg, #1565C0, #1976D2);
    color: white;
    margin-bottom: 12px;
  }

  /* ã‚·ãƒ•ãƒˆè¡¨ä½œæˆãƒœã‚¿ãƒ³ */
  .btn-shift {
    background: linear-gradient(135deg, #2E7D32, #43A047);
    color: white;
  }

  /* URLä¿å­˜ãƒœã‚¿ãƒ³ */
  .btn-save {
    background: #1976D2;
    color: white;
    padding: 12px;
    font-size: 14px;
  }

  /* å¹´æœˆå…¥åŠ› */
  .month-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
  }
  .month-input-group label {
    font-size: 14px;
    font-weight: 600;
    color: #616161;
    white-space: nowrap;
  }
  .month-input {
    flex: 1;
    padding: 10px 14px;
    border: 2px solid #E0E0E0;
    border-radius: 10px;
    font-size: 15px;
    outline: none;
    font-family: inherit;
    text-align: center;
  }
  .month-input:focus {
    border-color: #2E7D32;
  }

  /* çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
  .result-message {
    display: none;
    padding: 14px 16px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    margin-top: 14px;
    text-align: center;
    animation: fadeIn 0.3s ease;
  }
  .result-message.success {
    display: block;
    background: #E8F5E9;
    color: #2E7D32;
    border: 1px solid #C8E6C9;
  }
  .result-message.error {
    display: block;
    background: #FFEBEE;
    color: #C62828;
    border: 1px solid #FFCDD2;
  }
  .result-message.loading {
    display: block;
    background: #E3F2FD;
    color: #1565C0;
    border: 1px solid #BBDEFB;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* æ³¨æ„æ›¸ã */
  .note {
    font-size: 12px;
    color: #9E9E9E;
    text-align: center;
    margin-top: 8px;
    line-height: 1.6;
  }

  /* ã‚¹ãƒ”ãƒŠãƒ¼ */
  .spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2.5px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
  }
  .spinner.dark {
    border-color: rgba(0,0,0,0.15);
    border-top-color: #1565C0;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ãƒ•ãƒƒã‚¿ãƒ¼ */
  .footer {
    text-align: center;
    padding: 20px 16px;
    padding-bottom: max(env(safe-area-inset-bottom, 20px), 20px);
  }
  .footer a {
    color: #1976D2;
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
  }
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ›  å‹¤æ€ ç®¡ç† ç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>
  <p>ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆæ›´æ–°ãƒ»ã‚·ãƒ•ãƒˆè¡¨ä½œæˆ</p>
</div>

<div class="container">

  <!-- GAS URLè¨­å®š -->
  <div class="section">
    <div class="section-title">
      <span class="icon">âš™</span>
      GAS Webã‚¢ãƒ—ãƒªURL
    </div>
    <div class="url-input-group">
      <input type="url" id="gasUrl" class="url-input" placeholder="https://script.google.com/macros/s/..." />
      <div id="urlStatus" class="url-status">URLã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„</div>
      <button class="btn btn-save" onclick="saveUrl()">URLã‚’ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>

  <!-- ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆæ›´æ–° -->
  <div class="section">
    <div class="section-title">
      <span class="icon">ğŸ”„</span>
      ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆæ›´æ–°
    </div>
    <button class="btn btn-refresh" id="btnRefresh" onclick="refreshCheck()">
      <span class="btn-icon">ğŸ”„</span>
      ä»Šæœˆã®ãƒã‚§ãƒƒã‚¯ã‚’æ›´æ–°ã™ã‚‹
    </button>
    <div id="refreshResult" class="result-message"></div>
    <p class="note">æ‰“åˆ»ãƒ‡ãƒ¼ã‚¿ã¨ã‚·ãƒ•ãƒˆè¡¨ã‚’ç…§åˆã—ã€<br>ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆã‚’æœ€æ–°çŠ¶æ…‹ã«æ›´æ–°ã—ã¾ã™</p>
  </div>

  <!-- ã‚·ãƒ•ãƒˆè¡¨ä½œæˆ -->
  <div class="section">
    <div class="section-title">
      <span class="icon">ğŸ“‹</span>
      ã‚·ãƒ•ãƒˆè¡¨ä½œæˆ
    </div>
    <div class="month-input-group">
      <label>å¯¾è±¡æœˆ:</label>
      <input type="month" id="shiftMonth" class="month-input" />
    </div>
    <button class="btn btn-shift" id="btnShift" onclick="createShift()">
      <span class="btn-icon">ğŸ“‹</span>
      ã‚·ãƒ•ãƒˆè¡¨ã‚’ä½œæˆã™ã‚‹
    </button>
    <div id="shiftResult" class="result-message"></div>
    <p class="note">æŒ‡å®šã—ãŸæœˆã®ã‚·ãƒ•ãƒˆè¡¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’<br>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä½œæˆã—ã¾ã™</p>
  </div>

</div>

<div class="footer">
  <a href="javascript:void(0)" onclick="goToApp()">â† æ‰“åˆ»ã‚¢ãƒ—ãƒªã«æˆ»ã‚‹</a>
</div>

<script>
  // =============================================
  //  åˆæœŸåŒ–
  // =============================================
  
  var GAS_URL = "";
  var APP_URL = "";

  function init() {
    // ä¿å­˜æ¸ˆã¿ã®GAS URLã‚’èª­ã¿è¾¼ã‚€
    var savedUrl = localStorage.getItem("kintai_admin_gas_url") || "";
    GAS_URL = savedUrl;
    document.getElementById("gasUrl").value = savedUrl;
    
    if (savedUrl) {
      document.getElementById("urlStatus").textContent = "âœ… URLè¨­å®šæ¸ˆã¿";
      document.getElementById("urlStatus").className = "url-status saved";
    }
    
    // æ‰“åˆ»ã‚¢ãƒ—ãƒªã®URLã‚’èª­ã¿è¾¼ã‚€
    APP_URL = localStorage.getItem("kintai_admin_app_url") || "";
    
    // ã‚·ãƒ•ãƒˆè¡¨ã®å¹´æœˆã‚’æ¥æœˆã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
    var now = new Date();
    var nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    var ym = nextMonth.getFullYear() + "-" + String(nextMonth.getMonth() + 1).padStart(2, "0");
    document.getElementById("shiftMonth").value = ym;
  }

  // =============================================
  //  URLä¿å­˜
  // =============================================
  
  function saveUrl() {
    var url = document.getElementById("gasUrl").value.trim();
    if (!url) {
      document.getElementById("urlStatus").textContent = "âŒ URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
      document.getElementById("urlStatus").className = "url-status";
      return;
    }
    if (!url.startsWith("https://script.google.com/")) {
      document.getElementById("urlStatus").textContent = "âŒ GASã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
      document.getElementById("urlStatus").className = "url-status";
      return;
    }
    GAS_URL = url;
    localStorage.setItem("kintai_admin_gas_url", url);
    document.getElementById("urlStatus").textContent = "âœ… URLã‚’ä¿å­˜ã—ã¾ã—ãŸ";
    document.getElementById("urlStatus").className = "url-status saved";
  }

  // =============================================
  //  ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆæ›´æ–°
  // =============================================
  
  function refreshCheck() {
    if (!GAS_URL) {
      showResult("refreshResult", "error", "âŒ GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
      return;
    }
    
    var btn = document.getElementById("btnRefresh");
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> æ›´æ–°ä¸­...';
    showResult("refreshResult", "loading", '<span class="spinner dark"></span> ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¦ã„ã¾ã™...');
    
    var url = GAS_URL + "?action=refreshCheck";
    
    fetch(url, { method: "GET", mode: "cors" })
      .then(function(response) { return response.json(); })
      .then(function(data) {
        if (data.status === "success") {
          showResult("refreshResult", "success", "âœ… " + data.message);
        } else {
          showResult("refreshResult", "error", "âŒ " + data.message);
        }
      })
      .catch(function(error) {
        // GASã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§CORSã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã€no-corsã§å†è©¦è¡Œ
        fetch(url, { method: "GET", mode: "no-cors" })
          .then(function() {
            showResult("refreshResult", "success", "âœ… ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆæ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ");
          })
          .catch(function() {
            showResult("refreshResult", "error", "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + error.message);
          });
      })
      .finally(function() {
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">ğŸ”„</span> ä»Šæœˆã®ãƒã‚§ãƒƒã‚¯ã‚’æ›´æ–°ã™ã‚‹';
      });
  }

  // =============================================
  //  ã‚·ãƒ•ãƒˆè¡¨ä½œæˆ
  // =============================================
  
  function createShift() {
    if (!GAS_URL) {
      showResult("shiftResult", "error", "âŒ GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
      return;
    }
    
    var ym = document.getElementById("shiftMonth").value;
    if (!ym) {
      showResult("shiftResult", "error", "âŒ å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }
    
    var btn = document.getElementById("btnShift");
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> ä½œæˆä¸­...';
    showResult("shiftResult", "loading", '<span class="spinner dark"></span> ã‚·ãƒ•ãƒˆè¡¨ã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
    
    var url = GAS_URL + "?action=createShift&ym=" + encodeURIComponent(ym);
    
    fetch(url, { method: "GET", mode: "cors" })
      .then(function(response) { return response.json(); })
      .then(function(data) {
        if (data.status === "success") {
          showResult("shiftResult", "success", "âœ… " + data.message);
        } else {
          showResult("shiftResult", "error", "âŒ " + data.message);
        }
      })
      .catch(function(error) {
        fetch(url, { method: "GET", mode: "no-cors" })
          .then(function() {
            showResult("shiftResult", "success", "âœ… ã‚·ãƒ•ãƒˆè¡¨ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ");
          })
          .catch(function() {
            showResult("shiftResult", "error", "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + error.message);
          });
      })
      .finally(function() {
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">ğŸ“‹</span> ã‚·ãƒ•ãƒˆè¡¨ã‚’ä½œæˆã™ã‚‹';
      });
  }

  // =============================================
  //  ãƒ˜ãƒ«ãƒ‘ãƒ¼
  // =============================================
  
  function showResult(elementId, type, message) {
    var el = document.getElementById(elementId);
    el.className = "result-message " + type;
    el.innerHTML = message;
  }

  function goToApp() {
    // åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®index.htmlã«é·ç§»
    var currentUrl = window.location.href;
    var appUrl = currentUrl.replace(/admin\.html.*$/, "index.html");
    window.location.href = appUrl;
  }

  // åˆæœŸåŒ–å®Ÿè¡Œ
  init();
</script>

</body>
</html>
